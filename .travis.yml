language: php

php:
    - '7.1'

services:
    - mongodb

install:
    - echo 'date.timezone = "Europe/Paris"' >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
    # Enabling mongodb php extension & disabling xdebug
    - echo 'extension = mongo.so' >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
    - phpenv config-rm xdebug.ini
    # Debuging
    - mongo .travis/enable-mongo-logs.js

before_script:
    # Place into the right directory
    - cd htdocs/
    # Create user on MongoDB
    - sleep 15
    - mongo project --eval 'db.createUser({user:"admin",pwd:"admin",roles:["readWrite"]});'
    # Installing dependencies
    - composer install --prefer-source --optimize-autoloader
    - php -S localhost:8000 -t web/ &

script:
    - bin/phpunit.phar
#    - bin/phpspec run -fpretty
#    - bin/behat --no-snippets --verbose

after_failure:
    - cat var/logs/test.log
    - mongo .travis/debug-mongo.js




